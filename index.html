<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Pediatric Handover System</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PaedWard">
  <meta name="theme-color" content="#2a9d8f">
  <link rel="manifest" href="/pediatric-handover/manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="/pediatric-handover/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/pediatric-handover/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/pediatric-handover/icon-512.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root {
      --bg: #f4f7fb;
      --primary: #0066cc;
      --primary-dark: #004a99;
      --accent: #2a9d8f;
      --text: #1d3557;
      --card-bg: #ffffff;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --border: #aaa;
      --editable-border: #ccc;
      --editable-focus: #888;
      --PW: #d1e7ff;
      --GW: #fde2e4;
      --SW: #e2f0cb;
      --PVT: #fff3cd;
      --ICU: #d4edda;
      --NICU: #f8d7da;
      --ER: #f5f5f5;
      --Discharge: #e2e3e5;
      --new-btn: #f6a623;
      --discharge-btn: #28a745;
      --panel-width: 460px;
      --panel-height: 360px;
    }
    [data-theme="dark"] {
      --bg: #1a202c;
      --primary: #4299e1;
      --primary-dark: #2b6cb0;
      --accent: #38b2ac;
      --text: #e2e8f0;
      --card-bg: #2d3748;
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
      --border: #4a5568;
      --editable-border: #718096;
      --editable-focus: #a0aec0;
      --PW: #2c5282;
      --GW: #9b2c2c;
      --SW: #5a7f3f;
      --PVT: #b7791f;
      --ICU: #276749;
      --NICU: #9b2c2c;
      --ER: #4a5568;
      --Discharge: #3f3f46;
      --new-btn: #f6a623;
      --discharge-btn: #28a745;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; padding: 24px; background: var(--bg); color: var(--text); }
    h1 { margin: 0 0 24px; text-align: center; font-weight: 700; }
    .top-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .top-buttons button {
      padding: 10px 20px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    .top-buttons button:hover { transform: translateY(-2px); }
    .add { background: var(--primary); color: #fff; }
    .add:hover { background: var(--primary-dark); }
    .print { background: var(--accent); color: #fff; }
    .print:hover { background: #2c7a7b; }
    .theme-toggle {
      background: #6b7280;
      color: #fff;
      font-size: 18px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .theme-toggle:hover { background: #4b5563; }
    .theme-toggle::before { content: 'â˜€'; }
    [data-theme="dark"] .theme-toggle::before { content: 'ðŸŒ™'; }
    .top-panel {
      display: flex;
      gap: 16px;
      align-items: stretch;
      justify-content: center;
      margin: 0 auto 24px;
      max-width: 100%;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 4px;
    }
    .panel-card {
      background: var(--card-bg);
      padding: 18px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      width: var(--panel-width);
      height: var(--panel-height);
      flex: 0 0 var(--panel-width);
    }
    #handoverHeader { overflow: hidden; }
    #notesCard { overflow: auto; }
    #handoverHeader table {
      margin: 16px 0 0 0;
      border-collapse: collapse;
      width: 100%;
    }
    #handoverHeader th, #handoverHeader td {
      border: none;
      padding: 6px;
      font-size: 14px;
      vertical-align: top;
    }
    #handoverHeader th { background: var(--bg); }
    #notesCard strong { display: block; margin-bottom: 8px; }
    #notesText {
      width: 100%;
      min-height: 180px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      resize: vertical;
    }
    .form-section {
      display: none;
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      max-width: 520px;
      margin: 0 auto 32px;
      box-shadow: var(--shadow);
    }
    .form-section input, .form-section select, .form-section textarea {
      width: 100%;
      margin: 6px 0 12px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
    }
    .form-section button {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
    }
    .ward-header {
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      margin: 32px 0 8px;
      padding: 8px;
      border-radius: 8px;
    }
    .ward-header.discharge-header {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ward-header.discharge-header::before {
      content: 'â–º';
      margin-right: 8px;
      font-size: 16px;
    }
    .ward-header.discharge-header.expanded::before {
      content: 'â–¼';
    }
    .patient-card {
      background: var(--card-bg);
      width: 300px;
      padding: 18px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      position: relative;
      transition: transform 0.18s;
      padding-top: 48px;
    }
    .patient-card:hover { transform: scale(1.015); }
    .patient-card p { margin: 4px 0; }
    .patient-card p strong { font-weight: 700; }
    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0.7;
      background: #e63946;
      color: #fff;
    }
    .delete-btn:hover { opacity: 0.85; }
    .new-badge {
      position: absolute;
      top: 10px;
      right: 40px;
      background: var(--new-btn);
      color: #fff;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      display: none;
      opacity: 0.7;
      z-index: 10;
    }
    .new-badge.new-active { display: block; }
    .discharge-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--discharge-btn);
      color: #fff;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      display: none;
      opacity: 0.9;
      z-index: 10;
    }
    .discharge-badge.discharge-active {
      display: block;
    }
    .new-checkbox { margin-top: 8px; }
    .editable {
      border: none;
      background: transparent;
      border-bottom: 1px dashed var(--editable-border);
      padding: 0 4px;
      min-width: 20px;
      white-space: pre-wrap;
    }
    .editable:focus {
      outline: none;
      border-bottom: 1px solid var(--editable-focus);
    }
    .shift-select {
      border: none;
      background: transparent;
      border-bottom: 1px dashed var(--editable-border);
      padding: 0 4px;
      font-size: 16px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      cursor: pointer;
    }
    .shift-select:focus {
      outline: none;
      border-bottom: 1px solid var(--editable-focus);
    }
    .card-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    #ward-Discharge.card-grid {
      display: none;
    }
    #ward-Discharge.card-grid.expanded {
      display: flex;
    }
    .hopi-toggle {
      cursor: pointer;
      color: var(--text);
      font-weight: 600;
      margin: 4px 0;
    }
    .hopi-content { display: none; color: var(--text); }
    .hopi-content.expanded { display: block; }
    .print-window { padding: 20px; }
    .copy-btn {
      padding: 10px 20px;
      font-weight: 600;
      background: #6b7280;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.2s;
    }
    .copy-btn:hover { background: #4b5563; }
    pre { white-space: pre-wrap; font-family: 'Inter', monospace; }
    .log-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      margin: 8px 0;
    }
    .log-btn:disabled {
      cursor: not-allowed;
      background: #6c757d;
    }
    .log-btn:not(:disabled) {
      background: #28a745;
    }
    .plan-history.editable {
      list-style-type: disc;
      margin: 0;
      padding: 0;
      padding-left: 12px;
      text-indent: -12px;
      white-space: pre-wrap;
      min-height: 20px;
    }
    .plan-history.expanded + p { display: none; }
    #loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      font-weight: 600;
    }
    #dischargeModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      text-align: center;
    }
    #dischargeModal select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
    }
    #dischargeModal button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    #dischargeModal .confirm-btn {
      background: var(--primary);
      color: #fff;
    }
    #dischargeModal .confirm-btn:hover {
      background: var(--primary-dark);
    }
    #dischargeModal .cancel-btn {
      background: #6b7280;
      color: #fff;
    }
    #dischargeModal .cancel-btn:hover {
      background: #4b5563;
    }
  </style>
</head>
<body>
  <h1>Pediatric Handover</h1>
  <div class="top-buttons">
    <button class="add" onclick="toggleForm()">Add Patient</button>
    <button class="print" onclick="printAll()">Print All</button>
    <button class="print" onclick="printNICU()">Print NICU</button>
    <button class="print" onclick="printWard()">Print Ward</button>
    <button class="print" onclick="printNew()">Print New</button>
    <button class="theme-toggle" onclick="toggleDarkMode()" aria-label="Toggle theme"></button>
  </div>
  <div class="top-panel">
    <div id="handoverHeader" class="panel-card">
      <strong>Date:</strong> <span id="handoverDate">2025-09-04</span>
      <table>
        <tbody>
          <tr><th></th><th>Morning</th><th>Evening</th><th>Night</th></tr>
          <tr>
            <td>Admissions</td>
            <td><span id="adM">0</span></td>
            <td><span id="adE">0</span></td>
            <td><span id="adN">0</span></td>
          </tr>
          <tr>
            <td>Discharges</td>
            <td><span id="disM">0</span></td>
            <td><span id="disE">0</span></td>
            <td><span id="disN">0</span></td>
          </tr>
          <tr><td>Total Admissions</td><td colspan="3" id="totalAd">0</td></tr>
          <tr><td>Total Discharges</td><td colspan="3" id="totalDis">0</td></tr>
          <tr><td>Total Patients</td><td colspan="3" id="totalCount">0</td></tr>
          <tr>
            <td>By ward</td>
            <td colspan="3" id="wardBreakdown">PW (0), GW (0), SW (0), PVT (0), ICU (0), NICU (0), ER (0)</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="notesCard" class="panel-card">
      <strong>Notes/Pending work</strong>
      <textarea id="notesText" placeholder="Type pending tasks, callbacks, follow-ups..."></textarea>
    </div>
  </div>
  <div id="loading">Loading...</div>
  <div id="dischargeModal">
    <h3>Select Discharge Shift</h3>
    <select id="dischargeShiftSelect">
      <option value="Morning">Morning</option>
      <option value="Evening">Evening</option>
      <option value="Night">Night</option>
    </select>
    <div>
      <button class="confirm-btn" onclick="confirmDischarge()">Confirm</button>
      <button class="cancel-btn" onclick="cancelDischarge()">Cancel</button>
    </div>
  </div>
  <div class="form-section" id="formSection">
    <input type="text" id="name" placeholder="Name" required>
    <input type="text" id="id" placeholder="ID" required>
    <input type="text" id="doa" placeholder="Date of Admission (YYYY-MM-DD)" required>
    <select id="shift" required>
      <option value="Morning">Morning Shift</option>
      <option value="Evening">Evening Shift</option>
      <option value="Night">Night Shift</option>
    </select>
    <input type="text" id="bed" placeholder="Bed" required>
    <input type="text" id="age" placeholder="Age" required>
    <select id="sex">
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
    <input type="text" id="diagnosis" placeholder="Diagnosis">
    <input type="text" id="medications" placeholder="Medications">
    <input type="text" id="issues" placeholder="Issues">
    <textarea id="hopi" placeholder="HOPI"></textarea>
    <select id="ward">
      <option value="PW">PW</option>
      <option value="GW">GW</option>
      <option value="SW">SW</option>
      <option value="PVT">PVT</option>
      <option value="ICU">ICU</option>
      <option value="NICU">NICU</option>
      <option value="ER">ER</option>
    </select>
    <textarea id="plan" placeholder="Plan"></textarea>
    <label><input type="checkbox" id="isNew" checked> New</label>
    <button onclick="addPatient()">Submit</button>
  </div>
  <div id="wardsContainer"></div>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAC_qTA3N7NLTzLgPQwHh2HN7Z8YH89kp0",
      authDomain: "pediatric-handover-test.firebaseapp.com",
      projectId: "pediatric-handover-test",
      storageBucket: "pediatric-handover-test.firebasestorage.app",
      messagingSenderId: "103926797632",
      appId: "1:103926797632:web:7ad1a8a224541d540956a5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    document.getElementById("handoverDate").innerText = new Date().toISOString().split("T")[0];
    document.getElementById("doa").value = new Date().toISOString().split("T")[0];
    const notesEl = document.getElementById('notesText');
    const NOTES_DOC = db.collection('meta').doc('notes');
    let notesTyping = false;
    let notesDebounce;
    notesEl.addEventListener('input', () => {
      notesTyping = true;
      if (notesDebounce) clearTimeout(notesDebounce);
      notesDebounce = setTimeout(() => {
        NOTES_DOC.set({
          text: notesEl.value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).finally(() => {
          notesTyping = false;
        });
      }, 400);
    });
    NOTES_DOC.onSnapshot(snap => {
      const data = snap.data();
      if (data && typeof data.text === 'string') {
        if (!notesTyping && document.activeElement !== notesEl && notesEl.value !== data.text) {
          notesEl.value = data.text;
        }
      }
    });
    function toggleForm() {
      const form = document.getElementById('formSection');
      form.style.display = (form.style.display === 'block') ? 'none' : 'block';
    }
    function toggleDarkMode() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
    }
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    function formatDateForBadge(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}-${month}-${year}`;
    }
    function migrateDischargeData() {
      showLoading();
      db.collection('patients').where('ward', '==', 'Discharge').get().then(snap => {
        const batch = db.batch();
        snap.forEach(doc => {
          const data = doc.data();
          if (!data.dischargeTimestamp || !data.dischargeShift) {
            const updates = {};
            if (!data.dischargeTimestamp) {
              updates.dischargeTimestamp = data.timestamp || Date.now();
            }
            if (!data.dischargeShift) {
              updates.dischargeShift = 'Unknown';
            }
            batch.update(db.collection('patients').doc(doc.id), updates);
          }
        });
        return batch.commit();
      }).then(() => {
        console.log('Discharge data migration completed');
        calculateAdmissionsAndDischarges();
      }).catch(error => {
        console.error('Error migrating discharge data:', error);
        alert('Failed to migrate discharge data: ' + error.message);
      }).finally(() => {
        hideLoading();
      });
    }
    function migrateShiftData() {
      showLoading();
      const validShifts = ['Morning', 'Evening', 'Night'];
      db.collection('patients').get().then(snap => {
        const batch = db.batch();
        snap.forEach(doc => {
          const data = doc.data();
          if (data.shift && !validShifts.includes(data.shift)) {
            const normalizedShift = validShifts.find(shift => shift.toLowerCase().startsWith(data.shift.toLowerCase().slice(0, 3))) || 'Unknown';
            batch.update(db.collection('patients').doc(doc.id), { shift: normalizedShift });
          }
        });
        return batch.commit();
      }).then(() => {
        console.log('Shift data migration completed');
        calculateAdmissionsAndDischarges();
      }).catch(error => {
        console.error('Error migrating shift data:', error);
        alert('Failed to migrate shift data: ' + error.message);
      }).finally(() => {
        hideLoading();
      });
    }
    function addPatient() {
      showLoading();
      const patient = {
        name: document.getElementById('name').value,
        id: document.getElementById('id').value,
        doa: document.getElementById('doa').value,
        shift: document.getElementById('shift').value,
        bed: document.getElementById('bed').value,
        age: document.getElementById('age').value,
        sex: document.getElementById('sex').value,
        diagnosis: document.getElementById('diagnosis').value,
        medications: document.getElementById('medications').value,
        issues: document.getElementById('issues').value,
        hopi: document.getElementById('hopi').value,
        ward: document.getElementById('ward').value,
        plan: document.getElementById('plan').value,
        isNew: document.getElementById('isNew').checked,
        timestamp: Date.now(),
        logs: '',
        lastLoggedPlan: ''
      };
      db.collection('patients').add(patient).then(() => {
        document.getElementById('formSection').style.display = 'none';
        document.getElementById('formSection').reset();
        document.getElementById('doa').value = new Date().toISOString().split("T")[0];
        document.getElementById('isNew').checked = true;
      }).catch(error => {
        console.error("Error adding patient:", error);
        alert('Failed to add patient: ' + error.message);
      }).finally(() => {
        hideLoading();
      });
    }
    let currentDischargeId = null;
    function showDischargeModal(id) {
      showLoading();
      currentDischargeId = id;
      const modal = document.getElementById('dischargeModal');
      modal.style.display = 'block';
    }
    function confirmDischarge() {
      const shift = document.getElementById('dischargeShiftSelect').value;
      if (currentDischargeId && ['Morning', 'Evening', 'Night'].includes(shift)) {
        changeWard(currentDischargeId, 'Discharge', shift);
        document.getElementById('dischargeModal').style.display = 'none';
        currentDischargeId = null;
      } else {
        alert('Please select a valid shift.');
        hideLoading();
      }
    }
    function cancelDischarge() {
      document.getElementById('dischargeModal').style.display = 'none';
      const select = document.querySelector(`.patient-card[data-id="${currentDischargeId}"] select`);
      if (select) {
        select.value = document.querySelector(`.patient-card[data-id="${currentDischargeId}"] select option[selected]`).value;
      }
      currentDischargeId = null;
      hideLoading();
    }
    function deletePatient(id) {
      showLoading();
      const discharge = confirm("Discharge patient? Click 'OK' to move to Discharges");
      if (discharge) {
        showDischargeModal(id);
      } else {
        if (confirm("Are you sure you want to delete this patient?")) {
          db.collection('patients').doc(id).delete().then(() => {
            console.log('Patient deleted:', id);
          }).catch(error => {
            console.error("Error deleting patient:", error);
            alert('Failed to delete patient: ' + error.message);
          }).finally(() => {
            hideLoading();
          });
        } else {
          hideLoading();
        }
      }
    }
    function updateField(id, field, value) {
      db.collection('patients').doc(id).update({ [field]: value }).then(() => {
        console.log(`Field ${field} updated successfully for patient ${id}`);
        if (field === 'plan') {
          refreshButtonState(id);
        }
      }).catch(error => {
        console.error(`Error updating ${field}:`, error);
        alert('Failed to update field: ' + error.message);
        refreshButtonState(id);
      });
    }
    function updateLog(id, newText) {
      db.collection('patients').doc(id).update({ logs: newText }).then(() => {
        console.log(`Logs updated successfully for patient ${id}`);
      }).catch(error => {
        console.error('Error updating logs:', error);
        alert('Failed to update logs: ' + error.message);
      });
    }
    function changeWard(id, newWard, dischargeShift = null) {
      showLoading();
      db.collection('patients').doc(id).get().then(doc => {
        if (doc.exists) {
          const updates = { ward: newWard };
          if (newWard === 'Discharge') {
            updates.dischargeTimestamp = doc.data().dischargeTimestamp || Date.now();
            updates.dischargeShift = dischargeShift || doc.data().dischargeShift || 'Unknown';
          }
          db.collection('patients').doc(id).update(updates).then(() => {
            console.log(`Ward changed to ${newWard} for patient ${id}`);
            if (newWard === 'Discharge') {
              calculateAdmissionsAndDischarges();
            }
          }).catch(error => {
            console.error("Error changing ward:", error);
            alert('Failed to change ward: ' + error.message);
          }).finally(() => {
            hideLoading();
          });
        }
      });
    }
    function toggleNewTag(id) {
      db.collection('patients').doc(id).get().then(doc => {
        if (doc.exists) {
          const isNew = !doc.data().isNew;
          db.collection('patients').doc(id).update({ isNew: isNew }).then(() => {
            const badge = document.querySelector(`.new-badge[data-id="${id}"]`);
            if (badge) {
              badge.classList.toggle('new-active', isNew);
            }
          }).catch(error => {
            console.error("Error toggling new tag:", error);
            alert('Failed to toggle new tag: ' + error.message);
          });
        }
      });
    }
    function toggleHopi(id) {
      const content = document.getElementById(`hopi-content-${id}`);
      const toggle = document.getElementById(`hopi-toggle-${id}`);
      const newExpanded = !content.classList.contains('expanded');
      content.classList.toggle('expanded', newExpanded);
      toggle.setAttribute('aria-expanded', newExpanded);
      toggle.innerText = newExpanded ? 'HOPI: â–¼' : 'HOPI: â–º';
    }
    function togglePlan(id) {
      const content = document.getElementById(`plan-history-${id}`);
      const toggle = document.getElementById(`plan-toggle-${id}`);
      const newExpanded = !content.classList.contains('expanded');
      content.classList.toggle('expanded', newExpanded);
      toggle.setAttribute('aria-expanded', newExpanded);
      toggle.innerText = newExpanded ? 'Plan: â–¼' : 'Plan: â–º';
    }
    function logPlan(id) {
      showLoading();
      const planEl = document.querySelector(`#plan-content-${id}`);
      const text = planEl ? planEl.innerText.trim() : '';
      if (text === '') {
        console.log('Plan is empty, not logging');
        hideLoading();
        return;
      }
      const timestamp = Date.now();
      const formattedTimestamp = formatTimestamp(timestamp);
      const newLogEntry = `â€¢ ${formattedTimestamp}\n  ${text}\n\n`;
      db.collection('patients').doc(id).get().then(doc => {
        if (doc.exists) {
          const currentLogs = doc.data().logs || '';
          const updatedLogs = currentLogs + newLogEntry;
          db.collection('patients').doc(id).update({
            logs: updatedLogs,
            lastLoggedPlan: text
          }).then(() => {
            console.log('Plan logged successfully for patient', id);
            refreshButtonState(id);
          }).catch(error => {
            console.error('Error logging plan:', error);
            alert('Failed to log plan: ' + error.message);
            refreshButtonState(id);
          }).finally(() => {
            hideLoading();
          });
        }
      });
    }
    function refreshButtonState(id) {
      const planEl = document.querySelector(`#plan-content-${id}`);
      const logBtn = document.querySelector(`.log-btn[onclick="logPlan('${id}')"]`);
      if (!planEl || !logBtn) {
        console.error(`Cannot find plan or log button for patient ${id}`);
        return;
      }
      const currentPlan = planEl.innerText.trim();
      db.collection('patients').doc(id).get().then(doc => {
        if (doc.exists) {
          const lastLoggedPlan = doc.data().lastLoggedPlan || '';
          const needsLog = currentPlan === '' || currentPlan !== lastLoggedPlan;
          logBtn.disabled = !needsLog;
          logBtn.innerText = needsLog ? 'Log' : 'Logged';
          console.log(`Patient ${id}: needsLog=${needsLog}, currentPlan="${currentPlan}", lastLoggedPlan="${lastLoggedPlan}"`);
        }
      }).catch(error => {
        console.error(` planer-button-state for patient ${id}:`, error);
      });
    }
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }
    function toggleDischargeWard() {
      const grid = document.getElementById('ward-Discharge');
      const header = document.getElementById('header-Discharge');
      const isExpanded = grid.classList.contains('expanded');
      grid.classList.toggle('expanded', !isExpanded);
      header.classList.toggle('expanded', !isExpanded);
      console.log(`Toggled Discharge ward: ${isExpanded ? 'collapsed' : 'expanded'}`);
    }
    function generateReportHeader(type, date, adM, adE, adN, disM, disE, disN, totalAd, totalDis, totalCount) {
      if (type === 'NICU') {
        return `NICU HANDOVER\n` +
               `Date: ${date}\n` +
               `Shift: _\n` +
               `# Total number of neonates: ${totalCount}\n` +
               `# Number of admissions: _\n` +
               `# Number of shift outs: _\n` +
               `# Number of discharges: _\n\n` +
               `=======================\n\n`;
      } else if (type === 'Ward') {
        return `WARD HANDOVER\n` +
               `Date: ${date}\n` +
               `Shift: _\n` +
               `# Total number of patients: ${totalCount}\n` +
               `# Number of admissions: ${totalAd}\n` +
               `# Number of discharges: ${totalDis}\n\n` +
               `=======================\n\n`;
      } else {
        let text = `PEDIATRIC HANDOVER REPORT\n`;
        text += `Date: ${date}\n\n`;
        text += `ADMISSIONS/DISCHARGES SUMMARY\n`;
        text += `Admissions (Morning): ${adM}\n`;
        text += `Admissions (Evening): ${adE}\n`;
        text += `Admissions (Night): ${adN}\n`;
        text += `Total Admissions: ${totalAd}\n\n`;
        text += `Discharges (Morning): ${disM}\n`;
        text += `Discharges (Evening): ${disE}\n`;
        text += `Discharges (Night): ${disN}\n`;
        text += `Total Discharges: ${totalDis}\n\n`;
        text += `Total Patients: ${totalCount}\n\n`;
        text += `=======================\n\n`;
        return text;
      }
    }
    function generatePatientSection(patientsByWard, wards, type) {
      let text = '';
      wards.forEach(ward => {
        const patients = patientsByWard[ward];
        if (patients.length > 0) {
          text += `${ward.toUpperCase()} WARD (${patients.length} patients)\n`;
          text += '---------------------------------\n';
          patients.forEach(p => {
            const sexAbbr = p.sex?.charAt(0).toUpperCase() || '';
            let patientLine = `BED ${p.bed}`;
            if (type === 'NICU') {
              patientLine += ` - ${p.name}`;
            }
            patientLine += ` - ${p.age}/${sexAbbr}, ${p.diagnosis || 'N/A'}${p.isNew ? ' (NEW)' : ''}\n`;
            text += patientLine;
            if (p.medications) text += `Medications: ${p.medications}\n`;
            if (p.issues) text += `Issues: ${p.issues}\n`;
            if (p.hopi && p.isNew) text += `HOPI: ${p.hopi}\n`;
            if (p.plan) text += `Plan: ${p.plan}\n`;
            text += '---------------------------------\n';
          });
          text += '\n\n';
        }
      });
      return text;
    }
    function printReport(type, wardsToInclude, totalPatients) {
      showLoading();
      const date = document.getElementById('handoverDate').innerText;
      const adM = +document.getElementById('adM').innerText || 0;
      const adE = +document.getElementById('adE').innerText || 0;
      const adN = +document.getElementById('adN').innerText || 0;
      const disM = +document.getElementById('disM').innerText || 0;
      const disE = +document.getElementById('disE').innerText || 0;
      const disN = +document.getElementById('disN').innerText || 0;
      const totalAd = document.getElementById('totalAd').innerText;
      const totalDis = document.getElementById('totalDis').innerText;
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      db.collection('patients').where('ward', 'in', wardsToInclude).get().then(snap => {
        const wards = ["PW", "GW", "SW", "PVT", "ICU", "NICU", "ER"];
        const patientsByWard = {};
        wards.forEach(ward => patientsByWard[ward] = []);
        snap.forEach(doc => {
          const patient = doc.data();
          if (patient.ward !== 'Discharge') {
            patientsByWard[patient.ward].push({
              id: doc.id,
              ...patient
            });
          }
        });
        wards.forEach(ward => {
          patientsByWard[ward].sort((a, b) => {
            return (parseInt(a.bed) || 0) - (parseInt(b.bed) || 0);
          });
        });
        const reportText = generateReportHeader(type, date, adM, adE, adN, disM, disE, disN, totalAd, totalDis, totalPatients) +
                          generatePatientSection(patientsByWard, wardsToInclude, type);
        const textWindow = window.open('', '_blank');
        textWindow.document.write(`
          <html data-theme="${currentTheme}">
          <head>
            <title>Handover Report - ${type} - ${date}</title>
            <style>
              :root {
                --bg: ${currentTheme === 'dark' ? '#1a202c' : '#f4f7fb'};
                --text: ${currentTheme === 'dark' ? '#e2e8f0' : '#1d3557'};
                --card-bg: ${currentTheme === 'dark' ? '#2d3748' : '#ffffff'};
                --shadow: ${currentTheme === 'dark' ? '0 4px 12px rgba(0,0,0,0.3)' : '0 4px 12px rgba(0,0,0,0.08)'};
              }
              body { font-family: 'Inter', sans-serif; padding: 20px; background: var(--bg); color: var(--text); }
              .copy-btn {
                padding: 10px 20px;
                font-weight: 600;
                background: #6b7280;
                color: #fff;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                margin-bottom: 10px;
              }
              .copy-btn:hover { background: #4b5563; }
              pre { white-space: pre-wrap; font-family: 'Inter', monospace; }
            </style>
          </head>
          <body>
            <button class="copy-btn" onclick="navigator.clipboard.writeText(document.querySelector('pre').innerText).then(() => alert('Report copied to clipboard!')).catch(() => alert('Failed to copy report'))">Copy</button>
            <pre>${reportText}</pre>
          </body>
          </html>
        `);
        textWindow.document.close();
      }).catch(error => {
        console.error(`Error generating ${type} report:`, error);
        alert('Failed to generate report: ' + error.message);
      }).finally(() => {
        hideLoading();
      });
    }
    function printAll() {
      const totalCount = document.getElementById('totalCount').innerText;
      printReport('All', ["PW", "GW", "SW", "PVT", "ICU", "NICU", "ER"], totalCount);
    }
    function printNICU() {
      db.collection('patients').where('ward', '==', 'NICU').get().then(snap => {
        printReport('NICU', ['NICU'], snap.size);
      });
    }
    function printWard() {
      db.collection('patients').where('ward', 'in', ["PW", "GW", "SW", "PVT", "ICU", "ER"]).get().then(snap => {
        printReport('Ward', ["PW", "GW", "SW", "PVT", "ICU", "ER"], snap.size);
      });
    }
    function printNew() {
      showLoading();
      const date = document.getElementById('handoverDate').innerText;
      const adM = +document.getElementById('adM').innerText || 0;
      const adE = +document.getElementById('adE').innerText || 0;
      const adN = +document.getElementById('adN').innerText || 0;
      const disM = +document.getElementById('disM').innerText || 0;
      const disE = +document.getElementById('disE').innerText || 0;
      const disN = +document.getElementById('disN').innerText || 0;
      const totalAd = document.getElementById('totalAd').innerText;
      const totalDis = document.getElementById('totalDis').innerText;
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const wardsAll = ["PW", "GW", "SW", "PVT", "ICU", "NICU"];
      const wardsToInclude = ["PW", "GW", "SW", "PVT", "ICU", "NICU"];
      db.collection('patients').where('isNew', '==', true).get().then(snap => {
        const patientsByWard = {};
        wardsAll.forEach(w => patientsByWard[w] = []);
        snap.forEach(doc => {
          const p = doc.data();
          if (wardsToInclude.includes(p.ward)) {
            patientsByWard[p.ward].push({ id: doc.id, ...p });
          }
        });
        wardsToInclude.forEach(w => {
          patientsByWard[w].sort((a, b) => (parseInt(a.bed) || 0) - (parseInt(b.bed) || 0));
        });
        const includedCount = wardsToInclude.reduce((sum, w) => sum + patientsByWard[w].length, 0);
        const header = generateReportHeader('Ward', date, adM, adE, adN, disM, disE, disN, totalAd, totalDis, includedCount);
        const body = generatePatientSection(patientsByWard, wardsToInclude, 'Ward');
        const reportText = header + body;
        const textWindow = window.open('', '_blank');
        textWindow.document.write(`
          <html data-theme="${currentTheme}">
          <head>
            <title>Handover Report - NEW cases - ${date}</title>
            <style>
              :root {
                --bg: ${currentTheme === 'dark' ? '#1a202c' : '#f4f7fb'};
                --text: ${currentTheme === 'dark' ? '#e2e8f0' : '#1d3557'};
                --card-bg: ${currentTheme === 'dark' ? '#2d3748' : '#ffffff'};
                --shadow: ${currentTheme === 'dark' ? '0 4px 12px rgba(0,0,0,0.3)' : '0 4px 12px rgba(0,0,0,0.08)'};
              }
              body { font-family: 'Inter', sans-serif; padding: 20px; background: var(--bg); color: var(--text); }
              .copy-btn {
                padding: 10px 20px;
                font-weight: 600;
                background: #6b7280;
                color: #fff;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                margin-bottom: 10px;
              }
              .copy-btn:hover { background: #4b5563; }
              pre { white-space: pre-wrap; font-family: 'Inter', monospace; }
            </style>
          </head>
          <body>
            <button class="copy-btn" onclick="navigator.clipboard.writeText(document.querySelector('pre').innerText).then(() => alert('Report copied to clipboard!')).catch(() => alert('Failed to copy report'))">Copy</button>
            <pre>${reportText}</pre>
          </body>
          </html>
        `);
        textWindow.document.close();
      }).catch(err => {
        console.error('Error generating NEW cases report:', err);
        alert('Failed to generate NEW cases report: ' + err.message);
      }).finally(() => {
        hideLoading();
      });
    }
    function resetSummaryIfNeeded() {
      const now = new Date();
      const hours = now.getHours();
      const currentDate = now.toISOString().split('T')[0];
      const lastReset = localStorage.getItem('lastSummaryReset') || currentDate;
      if (currentDate !== lastReset && hours >= 10) {
        db.collection('summaries').doc('current').set({
          adM: 0, adE: 0, adN: 0,
          disM: 0, disE: 0, disN: 0,
          date: currentDate
        }).then(() => {
          localStorage.setItem('lastSummaryReset', currentDate);
          updateSummaryDisplay();
        }).catch(error => {
          console.error('Error resetting summary:', error);
          alert('Failed to reset summary: ' + error.message);
        });
      } else {
        updateSummaryDisplay();
      }
    }
    function updateSummaryDisplay() {
      db.collection('summaries').doc('current').onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('adM').innerText = data.adM || 0;
          document.getElementById('adE').innerText = data.adE || 0;
          document.getElementById('adN').innerText = data.adN || 0;
          document.getElementById('disM').innerText = data.disM || 0;
          document.getElementById('disE').innerText = data.disE || 0;
          document.getElementById('disN').innerText = data.disN || 0;
          document.getElementById('totalAd').innerText = (data.adM || 0) + (data.adE || 0) + (data.adN || 0);
          document.getElementById('totalDis').innerText = (data.disM || 0) + (data.disE || 0) + (data.disN || 0);
        }
      }, error => {
        console.error('Error listening to summary updates:', error);
        alert('Failed to update summary display: ' + error.message);
      });
    }
    function calculateAdmissionsAndDischarges() {
      const currentDate = document.getElementById('handoverDate').innerText;
      db.collection('patients').get().then(snap => {
        let adM = 0, adE = 0, adN = 0, disM = 0, disE = 0, disN = 0;
        snap.forEach(doc => {
          const patient = doc.data();
          if (patient.doa === currentDate) {
            if (patient.shift === 'Morning') adM++;
            else if (patient.shift === 'Evening') adE++;
            else if (patient.shift === 'Night') adN++;
          }
          if (patient.ward === 'Discharge' && patient.dischargeTimestamp) {
            const dischargeDate = new Date(patient.dischargeTimestamp).toISOString().split('T')[0];
            if (dischargeDate === currentDate && patient.dischargeShift) {
              if (patient.dischargeShift === 'Morning') disM++;
              else if (patient.dischargeShift === 'Evening') disE++;
              else if (patient.dischargeShift === 'Night') disN++;
            }
          }
        });
        db.collection('summaries').doc('current').set({
          adM, adE, adN,
          disM, disE, disN,
          date: currentDate
        }, { merge: true }).then(() => {
          console.log('Summary updated:', { adM, adE, adN, disM, disE, disN });
        }).catch(error => {
          console.error('Error updating summary:', error);
          alert('Failed to update summary: ' + error.message);
        });
      }).catch(error => {
        console.error('Error calculating admissions and discharges:', error);
        alert('Failed to calculate admissions and discharges: ' + error.message);
      });
    }
    function updatePatientCard(id, data, grid) {
      const existingCard = document.querySelector(`.patient-card[data-id="${id}"]`);
      if (!data) {
        if (existingCard) existingCard.remove();
        return;
      }
      const wards = ["PW", "GW", "SW", "PVT", "ICU", "NICU", "ER", "Discharge"];
      if (!wards.includes(data.ward)) return;
      const makeEditable = (field, label = '') =>
        `<p><strong>${label}</strong><span contenteditable class="editable" onblur="updateField('${id}', '${field}', this.innerText)">${data[field] || ''}</span></p>`;
      const logs = data.logs || 'No logs yet';
      let dischargeTag = '';
      if (data.ward === 'Discharge') {
        const dischargeDate = formatDateForBadge(data.dischargeTimestamp);
        const shiftText = data.dischargeShift || 'Unknown';
        dischargeTag = `<span class="discharge-badge discharge-active" data-id="${id}">Discharged${dischargeDate ? ` on ${dischargeDate}, ${shiftText} shift` : ''}</span>`;
      }
      const validShifts = ['Morning', 'Evening', 'Night'];
      const currentShift = validShifts.includes(data.shift) ? data.shift : 'Unknown';
      const card = existingCard || document.createElement('div');
      card.className = 'patient-card';
      card.setAttribute('data-id', id);
      card.innerHTML = `
        <button class="delete-btn" onclick="deletePatient('${id}')">Ã—</button>
        <span class="new-badge${data.isNew ? ' new-active' : ''}" data-id="${id}">NEW</span>
        ${dischargeTag}
        <p><strong>Name:</strong> <span contenteditable class="editable" onblur="updateField('${id}', 'name', this.innerText)">${data.name}</span>
           (ID: <span contenteditable class="editable" onblur="updateField('${id}', 'id', this.innerText)">${data.id || ''}</span>)</p>
        <p><strong>DOA:</strong> <span contenteditable class="editable" onblur="updateField('${id}', 'doa', this.innerText)">${data.doa || ''}</span>, 
           <strong>Shift:</strong> 
           <select class="shift-select" onchange="updateField('${id}', 'shift', this.value)">
             ${validShifts.map(sh => `<option value="${sh}" ${sh === currentShift ? 'selected' : ''}>${sh}</option>`).join('')}
             <option value="Unknown" ${currentShift === 'Unknown' ? 'selected' : ''}>Unknown</option>
           </select>
        </p>
        ${makeEditable('bed', data.ward === 'NICU' ? `Bed: ${data.name ? data.name : ''}` : 'Bed: ')}
        ${makeEditable('age', 'Age: ')}
        ${makeEditable('sex', 'Sex: ')}
        ${makeEditable('diagnosis', 'Diagnosis: ')}
        ${makeEditable('medications', 'Medications: ')}
        ${makeEditable('issues', 'Issues: ')}
        <p><strong class="hopi-toggle" id="hopi-toggle-${id}" onclick="toggleHopi('${id}')" aria-expanded="false">HOPI: â–º</strong></p>
        <div class="hopi-content" id="hopi-content-${id}">
          <span contenteditable class="editable" onblur="updateField('${id}', 'hopi', this.innerText)">${data.hopi || ''}</span>
        </div>
        <p><strong class="hopi-toggle" id="plan-toggle-${id}" onclick="togglePlan('${id}')" aria-expanded="false">Plan: â–º</strong></p>
        <div class="hopi-content plan-history" id="plan-history-${id}">
          <div contenteditable class="editable" onblur="updateLog('${id}', this.innerText)">${logs}</div>
        </div>
        <p><span contenteditable class="editable" id="plan-content-${id}" onblur="updateField('${id}', 'plan', this.innerText)">${data.plan || ''}</span></p>
        <button class="log-btn" onclick="logPlan('${id}')">Log</button>
        <p><strong>Ward:</strong>
          <select onchange="handleWardChange('${id}', this)">
            ${wards.map(wr => `<option value="${wr}" ${wr === data.ward ? 'selected' : ''}>${wr}</option>`).join('')}
          </select>
        </p>
        <p class="new-checkbox">
          <label><input type="checkbox" ${data.isNew ? 'checked' : ''} onchange="toggleNewTag('${id}')"> New</label>
        </p>
      `;
      const logBtn = card.querySelector('.log-btn');
      const currentPlan = data.plan || '';
      const lastLoggedPlan = data.lastLoggedPlan || '';
      const needsLog = currentPlan === '' || currentPlan !== lastLoggedPlan;
      logBtn.disabled = !needsLog;
      logBtn.innerText = needsLog ? 'Log' : 'Logged';
      if (!existingCard) {
        grid.appendChild(card);
      }
      refreshButtonState(id);
    }
    function handleWardChange(id, select) {
      const newWard = select.value;
      if (newWard === 'Discharge') {
        showDischargeModal(id);
      } else {
        changeWard(id, newWard);
      }
    }
    function loadPatients() {
      showLoading();
      const container = document.getElementById('wardsContainer');
      container.innerHTML = '';
      const wards = ["PW", "GW", "SW", "PVT", "ICU", "NICU", "ER", "Discharge"];
      const wardGrids = {};
      const wardCounts = {};
      wards.forEach(w => {
        const sec = document.createElement('div');
        const header = document.createElement('h2');
        header.className = 'ward-header';
        header.style.background = `var(--${w})`;
        header.id = `header-${w}`;
        header.innerText = w === 'Discharge' ? `Discharges` : w;
        if (w === 'Discharge') {
          header.classList.add('discharge-header');
          header.onclick = toggleDischargeWard;
        }
        sec.appendChild(header);
        const grid = document.createElement('div');
        grid.className = 'card-grid';
        grid.id = `ward-${w}`;
        if (w !== 'Discharge') {
          grid.classList.add('expanded');
        }
        sec.appendChild(grid);
        container.appendChild(sec);
        wardGrids[w] = grid;
        wardCounts[w] = 0;
      });
      const oneWeekMs = 7 * 24 * 60 * 60 * 1000;
      const now = Date.now();
      db.collection('patients').onSnapshot(snap => {
        let totalActive = 0;
        const currentDate = document.getElementById('handoverDate').innerText;
        wards.forEach(w => {
          wardGrids[w].innerHTML = '';
          wardCounts[w] = 0;
        });
        snap.forEach(doc => {
          const d = doc.data();
          const id = doc.id;
          if (d.ward === 'Discharge') {
            const dischargeTime = d.dischargeTimestamp || d.timestamp || now;
            if (dischargeTime < now - oneWeekMs) {
              console.log(`Deleting patient ${id} from Discharges: dischargeTimestamp=${dischargeTime} is over a week old`);
              db.collection('patients').doc(id).delete().catch(error => {
                console.error(`Error deleting patient ${id}:`, error);
              });
              return;
            }
          }
          if (wards.includes(d.ward)) {
            wardCounts[d.ward]++;
            if (d.ward !== 'Discharge') {
              totalActive++;
            }
            updatePatientCard(id, d, wardGrids[d.ward]);
          }
        });
        document.getElementById('totalCount').innerText = totalActive;
        wards.forEach(w => {
          const header = document.getElementById(`header-${w}`);
          if (header) {
            header.innerText = `${w === 'Discharge' ? 'Discharges' : w} (${wardCounts[w]} patient${wardCounts[w] !== 1 ? 's' : ''})`;
          }
        });
        const breakdownOrder = ["PW", "GW", "SW", "PVT", "ICU", "NICU", "ER"];
        const breakdownText = breakdownOrder.map(w => `${w} (${wardCounts[w] || 0})`).join(', ');
        const breakdownEl = document.getElementById('wardBreakdown');
        if (breakdownEl) breakdownEl.innerText = breakdownText;
        calculateAdmissionsAndDischarges();
        hideLoading();
      }, error => {
        console.error('Error loading patients:', error);
        alert('Failed to load patients: ' + error.message);
        hideLoading();
      });
    }
    loadTheme();
    resetSummaryIfNeeded();
    migrateDischargeData();
    migrateShiftData();
    loadPatients();
  </script>
</body>
</html>
